<!DOCTYPE html>
<html>
<head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <!-- Site Properities -->
    <title>ruby</title>

    <link rel="stylesheet" type="text/css" href="/dist/semantic.css">


    <script src="/javascripts/jquery-2.1.3.min.js"></script>
    <script src="/dist/semantic.js"></script>
    <!-- fabric JavaScript -->
    <script src="/javascripts/fabric.min.js"></script>
    <script src="/javascripts/board.js"></script>

</head>
<body>






    <div class="ui blue inverted large menu">
        <a class="item">
            <i class="home icon"></i> 首页
        </a>
        <a class="item">
            <i class="mail icon"></i> 宝石袋
        </a>
        <a class="active item">
            <i class="mail icon"></i> 社区
        </a>
        <div class="right menu">
            <div class="item">
                <div class="ui icon input">
                    <input type="text" placeholder="搜索中...">
                    <i class="search link icon"></i>
                </div>
            </div>
            <a class="item">注册</a>
            <a class="item">登录</a>
        </div>

    </div>




    <div style="margin: 20px auto; width: 1080px">

        <div class="ui top attached header">ui top attached header</div>
        <div class="ui blue  piled attached segment">
            <div class="ui blue header">
                讨论区
                <div id="save" class="ui button">save</div>
            </div>
            <div class="ui divider"></div>
            <canvas id="canvas" width="1050" height="1500" style=" border: 1px solid black">
                canvas</canvas>

            <div class="ui pagination menu">
                <a class="icon item">
                    <i class="left arrow icon"></i>
                </a>
                <a class="active item">
                    1
                </a>
                <div class="disabled item">
                    ...
                </div>
                <a class="item">
                    10
                </a>
                <a class="item">
                    11
                </a>
                <a class="item">
                    12
                </a>
                <a class="icon item">
                    <i class="right arrow icon"></i>
                </a>
            </div>
        </div>


    </div>

    <div class="ui gray segment">
        powered by oocomic.com
    </div>

    <!--sidebar -->
    <div id="imgbox" class="ui vertical overlay sidebar menu">

            <img src="/imgs/r1.jpeg" />


            <img src="/imgs/r2.jpeg" />

        <a class="item">
            <i class="facebook icon"></i>
            Facebook
        </a>
        <div class="item">
            <b>更多</b>
            <div class="menu">
                <a class="item">关于</a>
                <a class="item">联系我们</a>
            </div>
        </div>
    </div>
    <div id="btn_sidebar" style="left: -10px; top: 50px;  position: fixed" class="ui toggle teal button" >
        边栏
    </div>

    <div id="my_modal" class="ui modal">
        <i class="close icon"></i>
        <div class="header">
            对话框标题
        </div>
        <div class="content">
            <canvas id='modal-canvas' width='800' height='400'></canvas>
        </div>
        <div class="actions">
            <div class="ui button">取消</div>
            <div id="crop" class="ui button">确定</div>
        </div>
    </div>

<script>
    var json =<%- JSON.stringify(template.obj) %>;
    $( document ).ready(function() {
        console.log(json);
        var canvas = new fabric.Canvas('canvas');
        var m_canvas = new fabric.Canvas('modal-canvas');
        var stamp = null;

        $('#save').click(function() {
            var png = canvas.toDataURL();
            window.location.replace(png);
        });

        canvas.loadFromJSON(json, canvas.renderAll.bind(canvas));
        $('.overlay.sidebar').first().sidebar({
            overlay: true
        }).sidebar('attach events', '.toggle.button');

        $('#crop').click(function() {
            stamp.opacity = 0;
            //crop
            var dataUrl = null;
            dataUrl = m_canvas.toDataURL({
                top: stamp.top,
                left: stamp.left,
                width: stamp.width * stamp.scaleX,
                height: stamp.height *  stamp.scaleY
            });

            stamp = canvas.getActiveObject();

            fabric.Image.fromURL(dataUrl, function(iimg) {
                console.log('load img');
                iimg.top =  stamp.top;
                iimg.left = stamp.left;

//
                stamp.opacity =1;
                var stam_png = stamp.toDataURL();
                fabric.Image.fromURL(stam_png, function(mimg) {
                    console.log('load mask');
                    iimg.filters.push( new fabric.Image.filters.Mask( { 'mask': mimg, channel:3} ) );

                    iimg.applyFilters(canvas.renderAll.bind(canvas));
                    canvas.add(iimg);
                    canvas.remove(stamp);

                });


            });

            $('#myModal').modal('hide');
            m_canvas.clear();
        });

        $('#imgbox > img').click(function(e) {
            stamp = canvas.getActiveObject();
            console.log("===========e.target.src" + e.target.src);
            console.log("===========img click");
//        function handle_img_click(e) {
            if(!canvas.getActiveObject()) {
                return alert('请先在画板中选择一个图案，再点击图片剪切。');
            };
//            canvas.getActiveObject().clone(function (o) {
////                o.opacity = 0.5;
//                stamp = o;
//                console.log(o);
//                console.log("===========getActiveObject");
////                stamp.hasControls = false;
//            });
            //load img
            fabric.Image.fromURL(e.target.src, function (oimg) {
                if (oimg.width > 750) {
                    oimg.height = oimg.height * (750 / oimg.width);
                    oimg.width = 750;
                }
                m_canvas.centerObject(oimg);
                m_canvas.add(oimg);
                oimg.setCoords();

                var circle = new fabric.Circle({
                    radius: stamp.radius, fill: '#cccccc', left: 0, top: 0, opacity: 0.5
                });

                stamp = circle;


                m_canvas.centerObject(stamp);
                m_canvas.add(stamp).setActiveObject(stamp);
                stamp.setCoords();
            });
            $('#my_modal').modal('show');


            //});
        });



    });


</script>
</body>
</html>